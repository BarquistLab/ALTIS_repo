# Analysis of large-scale TraDIS infection screens with Stan (ALTIS)

Welcome to the ALTIS repository! This collection of Stan models is designed for studying invasion factors of pathogenic bacteria in large-scale infection screens with transposon mutant libraries followed by sequencing. The models, discussed in detail in [^f1], aim to extract fold-changes between mutant abundance in the inoculum and intracellular bacteria in the presence of infection bottlenecks [^f2]. Bottlenecks commonly occur in complex infection models such as organoid or animal models due to factors such as barrier defenses or nutritional restrictions, leading to a transient reduction in the population size irrespective of the fitness of individual mutants.

## Directory Structure:

<div class="columns-2">
  
  - **stan_models:** This directory contains the Stan models.
  - **R:** The R directory houses helpful R functions. While not mandatory for running Stan models, these functions can enhance downstream analysis.
  - **scripts:** R scripts required to reproduce Figure 1 and 2 in [^f1]. A short description of all scripts is provided in the section *Example Workflows*
  - **data:** Essential data files required for recreating Figure 1 and 2 in [^f1].
  - **annotations:** This directory contains the annotations used for the analysis of *Shigella* sequencing data [^f1].
  -**results:** The Figures and data files generated by the R scripts are stored here.

</div>

# Getting Started

## Installing and running the Stan models

To run the Stan models, various interfaces are available. The choice of interface depends on the dataset size, as fitting parameters might take several days, even with multithreading. For optimal performance, we recommend using the command-line interface of Stan, **cmdstan** (detailed example workflow provided in *normalize_TraDIS_screen.Rmd*). Alternatives are the R interface cmdstanr and the Python interace PyStan.

### Using cmdstan

1. **Install cmdstan**

Follow the comprehensive guide https://mc-stan.org/docs/2_31/cmdstan-guide/cmdstan-installation.html . The models have been tested with Stan v2.31.0.

2. **Enable multithreading**

The Stan models use the function ```reduce_sum```. To enhance computation speed, enable multithreading following the guide https://mc-stan.org/docs/2_31/cmdstan-guide/parallelization.html .

3. **Compile the Stan model**

After installing cmdstan, create a directory for the Stan model within the cmdstan directory. To compile the model, follow the instructions here: https://mc-stan.org/docs/2_31/cmdstan-guide/compiling-a-stan-program.html .

4. **Fitting the Stan model**

Below, we explain how to export the sequencing data to the R dump file Shigella_pseudo_data.R, located in the data directory. Alternatively, the JSON format can be used. After formatting the data, fit the decay rates using the following command

```
./LNM sample data file=Shigella_pseudo_data.R
```

Refer to the cmdstan instructions: https://mc-stan.org/docs/2_31/cmdstan-guide/mcmc-intro.html. The models have been tested with 1000 warmup iterations and 1000 sampling iterations.

## Example workflows

### Prerequisites

Before running the R scripts, ensure you have the necessary packges installed.

<div class="columns-2">
  
  - **CRAN** knitr, data.table, tidyverse, ggplot2, bayesplot
  - **github** cmdstanr (only required for workflow with cmdstanr): https://mc-stan.org/cmdstanr/
</div>

For additional packages required for the model comparison script, consult the "DESCRIPTION" file in the repository.

### List of workflows

In the directory **scripts**, you can find the Rmd files to analyze organoid infection assays with a Shigella Tn5 mutant library [^f1]. The files have been tested with R 4.3 and 4.4. They take less than 1 min to run on a desktop computer. The required data files are in the data directory.

<div class="columns-2">
  
  - **pilot_RNAseq_edgeR.Rmd** Shigella RNA-seq pilot experiment, edgeR analysis. Find differentially expressed genes at different growth temperatures and for virF and virB mutants.
  - **pilot_TraDIS_edgeR.Rmd** Test influence of enrichment conditions on Shigella TraDIS data.
  - **figures_genomic_positions.Rmd** Plot genomic positions of pilot TraDIS data and input to TraDIS infection screen.
  - **figures_pilot.Rmd** Plots required for Fig. 1. Run the two edgeR analyses first. In addition two the RNA-seq and TraDIS data analyzed with edgeR, this script analyzes pilot organoid TraDIS infections with 10,000 or 30,000 mutants to determine the infection bottleneck.
  - **normalize_TraDIS_screen.Rmd** Normalize sequencing data from TraDIS infection screen and export for cmdstan.
  - **figures_TraDIS_screen.Rmd** Compute fitness scores and create figures for Shigella infection screen with the cmdstan results.
  
 </div>

## Stan models

Stan is a probabilistic programming language. Find extensive documentation on how to develop and run Stan models on the Stan website: https://mc-stan.org/ . The implementation of Stan models is very efficient, because Stan separates model implementation from the sampling process.

The directory *stan_models* contains Stan model files to analyze TraDIS infection screens:

<div class="columns-2">
  
  - **ZINB_pair2_norm.stan** A zero-inflated negative binomial (ZINB) model for read count normalization of TraDIS infection screens with pair-wise structure (input-output pairs) in the presence of severe bottlenecks. Run this model on a subset of neutral genes which are not expected to contribute to the infection process, i.e. pseudogenes. Additonally, the model extracts important technical parameters like abundance-dependent stochastic loss.
  - **ZINB_pair2_logFC.stan** A zero-inflated negative binomial (ZINB) model which extracts gene-fitness scores (log-fold changes). It requires the technical parameters from ZINB_pair2_norm.stan as input. The data is expected to follow a pair-wise structure, i.e. for every transposon insertion site, an input and an output read count is required. See prepare_data.R in the R directory for details on how to export read counts in the correct format.

</div>
If you have questions on how to adapt the statistical models to your sequencing data, do not hesitate to contact the author directly.

## Exporting the read counts and metadata to cmdstan format with R

Export read counts and metadata for cmdstan using the rstan function ```stan_rdump```. The following quantities are required:

<div class="columns-2">
  
  - ```N_ti``` Total number of transposon insertion sites (TIS).
  - ```N_ti_max``` Max. number of non-zero TIs per input sample.
  - ```N_exp``` Number of input-output pairs.
  - ```Z_ps``` Fraction of pseudo genes with zero count in output (pair-wise).
  - ```N_g``` Number of genetic features.
  - ```it_g``` gene iterator, unique mapping from locus_tag to it_g required.
  
</div>

Organize the read counts of the TIS and their metadata in a data frame ```data_table``` with the following columns:

<div class="columns-2">
  
  - ```seq``` genomic sequence where the TIS integrated.
  - ```pos``` genomic position of TIS on ``seq```
  - ```locus_tag``` locus tag of genetic feature, character.
  - ```k``` The TIS is the kth insertion site in gene it_g.
  - ```type``` Feature type (e.g. CDS, pseudo). 
  - ```TI``` String which uniquely identifies the TIS.
  - ```Lib1_INPUT``` Read counts for first input sample.
  - ```Lib1_OUTPUT``` Read counts for first output sample.
  - ```Lib2_INPUT``` Read counts for second input sample.
  - ```Lib2_OUTPUT``` Read counts for second output sample.
  - ...
  
</div>

Rows with zero counts across all input samples have to be removed. For an example, see the file *results/normalize_TraDIS_screen/counts_all.csv*. The ```data_table``` is converted to raw_counts_in and raw_counts_out. Rows correspond to samples, columns correspond to TIS. Both data frames have to be in the same order.

Export the data via ```stan_rdump``` (see *R/prepare_data.R* for a function to create the required R dump file).

As explained in [^f1], *ZINB_pair2_norm.stan* extracts technical parameters:

<div class="columns-2">
  
  - ```norm_fac```
  - ```a[2]```
  - ```b```
  
</div>

*ZINB_pair2_logFC.stan* imports these technical parameters and computes gene-wise log-fold changes between input and output condition.

## Importing the cmdstan results with R

cmdstan saves the results from the HMC sampler in a csv file, e.g. *Shigella_pseudo_<chain_id>.csv* (for *ZINB_pair2_norm.stan*) and *Shigella_all_Bnorm_<chain_id>.csv* (for *ZINB_pair2_logFC.stan*). Since the csv files can be quite large, import them using ```fread```, e.g.

```
results_samples <- fread(cmd = 'grep -v "#" Shigella_all_Bnorm_<chain_id>.csv', data.table = F)
```

Extract the log-fold changes by running the command

```
logFC_g <- apply(results_samples[, grep("logFC_g", colnames(results_samples))], 2, median)
```

> **Note**
> 
> If the files are too large to import them with fread, extract the columns containing the relevant parameters using command line tools.

[^f1]: Maria Letizia Di Martino, Laura Jenniches, Anjeela Bhetwal, Jens Eriksson, Ana C. C. Lopes, Angeliki Ntokaki, Martina Pasqua, Magnus Sundbom, Martin Skogar, Wilhelm Graf, Dominic-Luc Webb, Per M. Hellström, André Mateus, Lars Barquist and Mikael E. Sellin. A Scalable Gut Organoid Model Reveals the Genome-Wide Invasion Landscape of a Human Restricted Pathogen (2024)
[^f2]: Cain, A.K., Barquist, L., Goodman, A.L., Paulsen, I.T., Parkhill, J., and van Opijnen, T. (2020). A decade of advances in transposon-insertion sequencing. Nat. Rev. Genet. 2020 219 21, 526–540. 10.1038/s41576-020-0244-x.
[^f3]: A. Vehtari, A. Gelman, J. Gabry, Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC. Stat.
1146 Comput. 27, 1413–1432 (2017).
[^f4]: http://avehtari.github.io/BDA_R_demos/demos_rstan/ppc/poisson-ppc.html
